<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>DengueAPP</title>
        <link rel="stylesheet" href="/VENDOR/BS/css/bootstrap.min.css">
        <link rel="stylesheet" href="/VENDOR/BSicon/font/bootstrap-icons.min.css">
        <link rel="stylesheet" href="/VENDOR/MosquitoShield/css/style.css">
        <style>
            #resourceTable {
                max-height: 300px;
                overflow-y: auto;
            }
        </style>
    </head>
    <body>
        <div class="wrapper">
            <div id="navbarContainer"></div>
            <div class="container">
            <h2 class="container-title pb-5">Resource Management</h2>
                <div class="container-content">
                    <div class="form-container mb-5">
                    <h4>Search Resource</h4>
                    <form id="searchResourceForm" class="row g-2">
                        <div class="col-4">
                        <label for="descriptionInput" class="form-label">Description</label>
                        <input type="text" class="form-control" id="descriptionInput" placeholder="Enter the description">
                        </div>
                        <div class="col-4">
                        <label for="urlInput" class="form-label">Link URL</label>
                        <input type="text" class="form-control" id="urlInput" placeholder="Enter the link URL">
                        </div>
                        <div class="col-4">
                        <label for="typeInput" class="form-label">Type</label>
                        <input type="text" class="form-control" id="typeInput" placeholder="Enter the type">
                        </div>
                        <button type="submit" class="col-1 btn btn-success">Search</button>
                    </form>
                    </div>
                
                    <h4>Resource List</h4>
                    <div id="resourceTable" class="table-responsive pt-3">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>No.</th>
                            <th>Link URL</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody id="resourceTableBody">
                        </tbody>
                    </table>
                    </div>
                    <div class="d-flex justify-content-end my-3 me-3">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addResourceModal">Add</button>
                    </div>
                </div>          
            </div>
        </div>
        <div class="modal fade" id="editResourceModal" tabindex="-1" aria-labelledby="editResourceModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editResourceModalLabel">Edit Resource</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editResourceForm">
                            <div class="row">
                                <div class="col-4">
                                    <label for="editUrlInput" class="form-label">Link URL</label>
                                    <input type="text" class="form-control" id="editUrlInput" placeholder="Enter the link URL">
                                </div>
                                <div class="col-4">
                                    <label for="editTypeInput" class="form-label">Type</label>
                                    <input type="text" class="form-control" id="editTypeInput" placeholder="Enter the type">
                                </div>
                                <div class="col-4">
                                    <label for="editDescriptionInput" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="editDescriptionInput" placeholder="Enter the description">
                                </div>
                            </div>
                            <div class="modal-footer" style="border-top:none;">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" id="editSubmitButton" class="btn btn-primary">Update</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="addResourceModal" tabindex="-1" aria-labelledby="addResourceModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addResourceModalLabel">Add Resource</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addResourceForm">
                            <div class="row">
                                <div class="col-4">
                                    <label for="addUrlInput" class="form-label">Link URL</label>
                                    <input type="text" class="form-control" id="addUrlInput" placeholder="Enter the link URL">
                                </div>
                                <div class="col-4">
                                    <label for="addTypeInput" class="form-label">Type</label>
                                    <input type="text" class="form-control" id="addTypeInput" placeholder="Enter the type">
                                </div>
                                <div class="col-4">
                                    <label for="addDescriptionInput" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="addDescriptionInput" placeholder="Enter the description">
                                </div>
                            </div>
                            <div class="modal-footer" style="border-top:none;">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" id="addSubmitButton" class="btn btn-primary">Add</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script src="/VENDOR/BS/js/bootstrap.bundle.min.js"></script>
    <script>
      fetch('/navbar')
        .then(response => response.text())
        .then(data => {
          const navbarContainer = document.getElementById('navbarContainer');
          navbarContainer.innerHTML = data;
          const navbarScript = document.createElement('script');
          navbarScript.src = "/VENDOR/MosquitoShield/js/navbar.js";
          document.body.appendChild(navbarScript);
        })
        .catch(error => {
          console.error('Error:', error);
        });
    </script>
    <script>
        function searchFormSubmit(event) {
            event.preventDefault();

            const linkUrl = document.getElementById('urlInput').value;
            const type = document.getElementById('typeInput').value;
            const description = document.getElementById('descriptionInput').value;

            const formData = {
                linkUrl: linkUrl,
                type: type,
                description: description
            };

            fetch('/api/resourcemanage/search', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    updateResourceTable(data.result);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        function editFormSubmit(event) {
            event.preventDefault();

            const linkUrl = document.getElementById('editUrlInput').value;
            const type = document.getElementById('editTypeInput').value;
            const description = document.getElementById('editDescriptionInput').value;
            const linkId = document.getElementById('editSubmitButton').getAttribute('data-id')

            if (linkUrl.trim() == "" || type.trim() == "" || description.trim() == "") {
                alert("Please fill in all input fields")
                return;
            }

            const formData = {
                linkUrl: linkUrl,
                type: type,
                description: description,
                linkId: linkId
            };

            const confirmed = window.confirm('Are you sure you want to update the resource?');
            if (!confirmed) {
                return;
            }

            fetch('/api/resourcemanage/edit', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status == 'success') {
                        location.reload();
                    }
                    else if (data.status == 'fail') {
                        console.log(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function addFormSubmit(event) {
            event.preventDefault();

            const linkUrl = document.getElementById('addUrlInput').value;
            const type = document.getElementById('addTypeInput').value;
            const description = document.getElementById('addDescriptionInput').value;

            if (linkUrl.trim() == "" || type.trim() == "" || description.trim() == "") {
                alert("Please fill in all input fields")
                return;
            }

            const formData = {
                linkUrl: linkUrl,
                type: type,
                description: description,
            };

            const confirmed = window.confirm('Are you sure you want to add the resource?');
            if (!confirmed) {
                return;
            }

            fetch('/api/resourcemanage/add', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status == 'success') {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function deleteResource(event) {
            event.preventDefault();

            const row = event.target.closest('tr');
            const linkId = row.querySelector('.delete-btn').getAttribute('data-id')
            const confirmed = window.confirm('Are you sure you want to add the resource?');
            if (!confirmed) {
                return;
            }

            const formData = {
                linkId: linkId
            };

            fetch('/api/resourcemanage/delete', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status == 'success') {
                        alert("Resource Link Deleted !")
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function updateResourceTable(data) {
            const tableBody = document.getElementById('resourceTableBody');
            tableBody.innerHTML = ''; 

            console.log(data)
            if (data.length > 0) {
                data.forEach((resource, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="index">${index + 1}</td>
                        <td class="link-url">${resource.LinkUrl}</td>
                        <td class="type">${resource.Type}</td>
                        <td class="description">${resource.Description}</td>
                        <td class="action">
                            <button class="btn btn-sm btn-primary edit-btn" data-id="${resource.LinkId}" data-bs-toggle="modal" data-bs-target="#editResourceModal"><i class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${resource.LinkId}"><i class="bi bi-trash-fill"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                const editButtons = document.querySelectorAll('.edit-btn');
                editButtons.forEach(button => {
                    button.addEventListener('click', populateEditModal);
                });

                const deleteButtons = document.querySelectorAll('.delete-btn');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', deleteResource);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5">No resources found.</td>';
                tableBody.appendChild(row);
            }
        }

        function populateEditModal(event) {
            const editUrlInput = document.getElementById('editUrlInput');
            const editTypeInput = document.getElementById('editTypeInput');
            const editDescription = document.getElementById('editDescriptionInput');
            const editSubmitButton = document.getElementById('editSubmitButton');
            
            const row = event.target.closest('tr');
            const resourceId = row.querySelector('.edit-btn').getAttribute('data-id');
            const linkUrl = row.querySelector('.link-url').textContent;
            const type = row.querySelector('.type').textContent;
            const description = row.querySelector('.description').textContent;

            editUrlInput.value = linkUrl;
            editTypeInput.value = type;
            editDescriptionInput.value = description;
            editSubmitButton.setAttribute('data-id', resourceId);
        }

        document.addEventListener('DOMContentLoaded', searchFormSubmit);
        const searchResourceForm = document.getElementById('searchResourceForm');
        searchResourceForm.addEventListener('submit', searchFormSubmit);

        const editResourceForm = document.getElementById('editResourceForm');
        editResourceForm.addEventListener('submit', editFormSubmit);
        const editResourceModal = document.getElementById('editResourceModal');
        editResourceModal.addEventListener('hidden.bs.modal', function () {
            const editUrlInput = document.getElementById('editUrlInput');
            const editTypeInput = document.getElementById('editTypeInput');
            const editDescriptionInput = document.getElementById('editDescriptionInput');
            const editSubmitButton = document.getElementById('editSubmitButton');

            editUrlInput.value = '';
            editTypeInput.value = '';
            editDescriptionInput.value = '';
            editSubmitButton.removeAttribute('data-id');
        }); 

        const addResourceForm = document.getElementById('addResourceForm');
        addResourceForm.addEventListener('submit', addFormSubmit);
        const addResourceModal = document.getElementById('addResourceModal');
        addResourceModal.addEventListener('hidden.bs.modal', function () {
            const addUrlInput = document.getElementById('addUrlInput');
            const addTypeInput = document.getElementById('addTypeInput');
            const addDescriptionInput = document.getElementById('addDescriptionInput');

            editUrlInput.value = '';
            editTypeInput.value = '';
            editDescriptionInput.value = '';
        }); 
    </script>
</html>